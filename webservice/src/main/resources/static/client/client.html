<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <title></title>
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light ">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="#">VA Telehealth Resource Management Tool</a>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">About <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Help</a>
          </li>
        </ul>

      </div>
    </nav>
    <div class="container" id="mainContainer">
      <div class="row">
        <div class="col">
          <div class="card">control and config here</div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="card">goal row </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Visits / Facilities</h5>
              <h6 class="card-subtitle mb-2 visitCount">No Visits / Facilities</h6>
              <div id="visitDonut"></div>

            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-text" id="bandwidthDiv">
              Bandwidth / Time
            </div>
            <div class="card-text" id="timeSavedDiv">
              Hours/Miles Saved
            </div>
          </div>

        </div>
      </div>
      <div class="row">
        <div class="card">
          <div class="card">Virtual Care Trained Providers</div>
          <div class="row">
            <div class="col text-center">
              <img src="images/VA_Telehealth_Dashboard_Icons_VC_DOC_114.svg" />
            </div>
            <div class="col align-self-center font-weight-bold">109</div>
          </div>

        </div>
        <div class="col">
          <div class="card">Virtual Care Trained Nurses</div>
          <div class="row">
            <div class="col text-center">
              <img src="images/VA_Telehealth_Dashboard_Icons_VC_NURSE_114.svg" />
            </div>
            <div class="col align-self-center font-weight-bold">109</div>
          </div>
        </div>
        <div class="col">
          <div class="card">Virtual Care Technicians</div>
          <div class="row">
            <div class="col text-center">
              <img src="images/VA_Telehealth_Dashboard_Icons_VC_TECH_114.svg" />
            </div>
            <div class="col align-self-center font-weight-bold">109</div>
          </div>

        </div>
        <div class="col">
          <div class="card">Virtual Care Rooms</div>
          <div class="row">
            <div class="col text-center">
              <img src="images/VA_Telehealth_Dashboard_Icons_VC_ROOMS_114.svg" />
            </div>
            <div class="col align-self-center font-weight-bold">109</div>
          </div>

        </div>
      </div>
      <div class="row">
        <div class="col" style="padding-left: 0px;">
          <div class="card">
            <div style="height:500px;" id="map">MAP</div>
          </div>

        </div>
        <div class="col">
          <div class="card">Facilty info</div>

        </div>
      </div>
      <div class="row">
        <div class="card">
          <h5 class="card-title">Dev Info, Temporary</h5>
          <p class="card-body">Earliest Encounter: <span id="encounterFirst"></span></p>
          <p class="card-body">Last Encounter: <span id="encounterLast"></span></p>


        </div>
      </div>


    </div>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- general -->
    <script type="text/javascript">
      // let's figure out nicer ways to make everything live, maybe when we can vue up after all at some point, it supports incremental updates allegedly

      $(document).ready(function () {
        window.leaflet_map = L.map('map').setView([42.3695, -71.9481], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(leaflet_map);

        google.charts.load('current', {'packages': ['corechart']});
        google.charts.load('current', {'packages': ['line']});
        google.charts.setOnLoadCallback(buildCharts);

      });
    </script>

    <!-- websocket -->
    <script type="text/javascript">
      let ws;
      let uuid;
      let count = 0;
      let connected = false;

      function updateMessage(message) {
        //$('#message').html(message);
        //console.debug(message);
      }

      function connect(url = 'ws://localhost:8080/va-synthea/ws') {
        encounterStats = {};
        try {
          ws = new WebSocket(url);
          ws.onopen = function (event) {
            connected = true;
          };

          ws.onclose = function (event) {
            if (connected) {
              connected = false;
              updateMessage('Connection closed');
            } else {
              updateMessage('Could not connect');
            }
          };

          ws.onmessage = function (event) {
            try {

              let data = JSON.parse(event.data);
              if (data['uuid']) {
                // Got UUID for configured request
                uuid = data['uuid'];
                count = 0;
              }
              if (data['error']) {
                // Got error message
                updateMessage(data['error']);
              } else if (data['status']) {
                // Got status message
                updateMessage(data['status']);
                if (data['status'] === 'Completed') {
                  // Request has completed
                  count = 0;
                }

                if (data['configuration']) {
                  console.log(data['configuration']);
                }

              } else {
                processFHIR(data)
                // Got a person
                //$('#count').html(++count);
              }
            } catch (jex) {
              console.error(jex);
            }
          };
        } catch (ex) {
          console.error(ex);
      }
      }

      function configure(config = {population: 50}) {
        let message = {operation: 'configure', configuration: config};
        ws.send(JSON.stringify(message));
      }

      function start() {
        updateMessage('Please wait...');
        let message = {operation: 'start', uuid: uuid};
        ws.send(JSON.stringify(message));
      }

      function stop() {
        updateMessage('Please wait...');
        let message = {operation: 'stop', uuid: uuid};
        ws.send(JSON.stringify(message));
      }

      function updateRequest() {
        updateMessage('Please wait...');
        let message = {operation: 'update-request', uuid: uuid, configuration: {'state': 'Massachusetts', 'module.encounter.telemed_adoption_values': '1900:0,2000:0,2017:0.9'}};
        ws.send(JSON.stringify(message));
      }

    </script>

    <!-- patient munging code -->
    <!-- some of this should be absorbed into a FHIR class that parses records -->
    <!-- some of it should be moved out to a vizualization class, maybe off event broadcasts -->
    <script type="text/javascript">

      let known_patients = new Array();
      let encounterTimeBoundaries = {earliest: Number.MAX_SAFE_INTEGER, last: Number.MIN_SAFE_INTEGER};
      let encounterStats = {"Waiting For Data": 1};
      function processFHIR(fhir) {

        let home_locs = processPatientLocations(fhir);
        mapPatient(home_locs);
        let org_locs = processOrganizationLocations(fhir);
        mapOrganizations(org_locs);
        let encounterInfo = processPatientEncounters(fhir);
        let patientEncounterStats = encounterInfo.encounterStats;
        Object.keys(patientEncounterStats).forEach(function (key) {
          if (encounterStats[key] == undefined)
            encounterStats[key] = patientEncounterStats[key];
          else
            encounterStats[key] += patientEncounterStats[key];
        });
        updateEncounterViz();
      }

      let patientMarkers = [];
      let orgMarkers = [];
      function mapPatient(locations = []) {
        locations.forEach(function (loc, index) {
          let ll = [loc.latitude, loc.longitude];
//          let marker = L.marker(ll);
          let marker = L.circle(ll, {
            color: 'blue',
            fillColor: 'lightblue',
            fillOpacity: 0.5,
            radius: 500
          })
          patientMarkers.push(marker);
          marker.addTo(window.leaflet_map);
        });
      }
      function mapOrganizations(locations = []) {
        locations.forEach(function (loc) {
          let ll = [loc.latitude, loc.longitude];
//          let marker = L.marker(ll);
          let marker = L.circle(ll, {
            color: 'red',
            fillColor: 'pink',
            fillOpacity: 0.5,
            radius: 500
          })
          
          orgMarkers.push(marker);
          marker.addTo(window.leaflet_map);
        });
      }


      function processPatientEncounters(fhir) {
        let encounters = getByResourceType(fhir, "Encounter");
        let encounterNumbers = {};
        encounters.forEach(function (encounter, index) {
          let resource = encounter.resource;
          let code = resource.class.code.toLowerCase();
          let start = Date.parse(resource.period.start);
          let end = Date.parse(resource.period.end);
          if (start < encounterTimeBoundaries.earliest) {
            encounterTimeBoundaries.earliest = start;
            $("#encounterFirst").text(new Date(start));
          }
          if (end > encounterTimeBoundaries.last) {
            encounterTimeBoundaries.last = end;
            $("#encounterLast").text(new Date(start));
          }

          if (encounterNumbers[code] == undefined)
            encounterNumbers[code] = 1;
          else
            encounterNumbers[code]++;
        });

        window.encounters = encounters;
        return {"encounters": encounters, "encounterStats": encounterNumbers};
      }
      function processPatientLocations(fhir) {
        let home_locations = getByResourceType(fhir, "Patient");
        home_lls = new Array();
        home_locations.forEach(function (person, index) {
          let addresses = person.resource.address;
          addresses.forEach(function (address, index) {
            address.extension.forEach(function (extension, index) {

              let latlon = {};

              latlon = processLocationExtension(extension);
//              extension.extension.forEach(function (ext, idx) {
//                if (ext.url == "latitude")
//                  latlon.latitude = ext.valueDecimal;
//                else if (ext.url == "longitude")
//                  latlon.longitude = ext.valueDecimal;
//              });
              if (latlon == null || (latlon.latitude != undefined && latlon.longitude != undefined))
                home_lls.push(latlon);
            });
          });

        });
        return home_lls;
      }

      function processOrganizationLocations(fhir) {
        let orgs = getByResourceType(fhir, "Organization");
        let org_locs = [];
        orgs.forEach(function (org) {
          if (org.resource.extension != null) {
            org.resource.extension.forEach(function (extension) {
              let loc = processLocationExtension(extension);
              if (loc != null)
                org_locs[org_locs.length] = loc;

            });
          }
        });
        return org_locs;
      }

      function processLocationExtension(holder) {
        let latlon = {};
        holder.extension.forEach(function (ext, idx) {
          if (ext.url == "latitude")
            latlon.latitude = ext.valueDecimal;
          else if (ext.url == "longitude")
            latlon.longitude = ext.valueDecimal;
        });
        if (latlon.latitude != undefined && latlon.longitude != undefined)
          return latlon;
        else
          return null;
      }

      function getByResourceType(fhir, resourceType) {
        return fhir.entry.filter(obj => {
          return obj.resource.resourceType === resourceType;
        });
      }

    </script>

    <script type="text/javascript">

      let visitChart;
      let savingsChart;
      function buildCharts() {
        var options = {
          title: 'Visits',
          pieHole: 0.4,
        };

        visitChart = new google.visualization.PieChart(document.getElementById('visitDonut'));


        mockupSavingChart();

      }

      function mockupSavingChart() {
        let data = new google.visualization.DataTable();
        data.addColumn('date', 'Date');
        data.addColumn('number', 'Time Saved');
        data.addColumn('number', 'Travel Saved');
        data.addColumn('number', 'Bandwith Used')
        data.addRows([
          [new Date(2000, 1, 1), 100, 100, 50],
          [new Date(2005, 1, 1), 500, 500, 96],
          [new Date(2010, 1, 1), 1300, 750, 1999],
          [new Date(2015, 1, 1), 2380, 1900, 2432]
        ]);


        var options = {
          chart: {
            title: 'Time and Mileage Saved',
            subtitle: '(hours / hundreds of miles)'
          },
          height: 300 - 39, // I should stop being a monster
          hAxis: {
            scaleType: 'continuous'
          }
        };

        savingsChart = new google.charts.Line(document.getElementById('timeSavedDiv'));

        savingsChart.draw(data, google.charts.Line.convertOptions(options));
      }

      function updateEncounterViz() {
        let total = 0;
        let keys = Object.keys(encounterStats);
        if (keys.length == 0)
          return;
        let values = [["Type", "# of Visits"]];
        keys.forEach(function (key) {
          values[values.length] = [key, encounterStats[key]];
          total += encounterStats[key];
        });
        let data = google.visualization.arrayToDataTable(values);
        visitChart.draw(data, {pieHole: 0.4});
        $(".visitCount").text(total + " / " + orgMarkers.length);

      }


    </script>
  </body>
</html>